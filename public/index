<?php
declare(strict_types=1);

/**
 * Index — definitivo (sem loop, com fallback e debug opcional)
 */
require_once __DIR__ . '/conexao.php';
require_once __DIR__ . '/config.php';

// Login/permissões do seu projeto
if (function_exists('exigeLogin')) exigeLogin();
if (function_exists('refreshPermissoes')) {
    try { refreshPermissoes($pdo); } catch (Throwable $e) {
        if (getenv('APP_DEBUG') === '1') error_log('[refreshPermissoes] '.$e->getMessage());
    }
}

// página solicitada
$page = (string)($_GET['page'] ?? 'dashboard');
$page = preg_replace('/[^a-z0-9_\-]/i', '', $page);

// mapa fixo garante dashboard.php
$routes_fixed = ['dashboard' => __DIR__ . '/dashboard.php'];

// mescla com rotas do seu config (se existirem)
if (isset($routes) && is_array($routes)) {
    $norm = [];
    foreach ($routes as $k => $v) {
        $norm[$k] = str_contains($v, DIRECTORY_SEPARATOR) ? $v : (__DIR__ . '/' . ltrim($v, '/'));
    }
    // FIXO tem prioridade para evitar loop em 'dashboard'
    $routes = array_merge($norm, $routes_fixed);
} else {
    $routes = $routes_fixed;
}

// resolve alvo
$alvo = $routes[$page] ?? null;

// fallback: page.php e page-2.php
if (!$alvo || !is_file($alvo)) {
    foreach ([__DIR__."/{$page}.php", __DIR__."/{$page}-2.php"] as $c) {
        if (is_file($c)) { $alvo = $c; break; }
    }
}

if (!$alvo || !is_file($alvo)) {
    http_response_code(404);
    echo "<!doctype html><meta charset='utf-8'><style>body{font-family:system-ui;background:#0b1a33;color:#fff;padding:40px}</style><h1>404</h1><p>Página não encontrada.</p>";
    if (getenv('APP_DEBUG') === '1') { error_log("[route404] page={$page}"); }
    exit;
}

// buffer para evitar "headers already sent"
ob_start();
require $alvo;
$conteudo = ob_get_clean();

// se houve redirect, não imprime layout
foreach (headers_list() as $h) { if (stripos($h, 'Location:') === 0) exit; }

// debug opcional no log
if (getenv('APP_DEBUG') === '1') { error_log("[route] page={$page} alvo={$alvo}"); }
?>
<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Painel Smile — <?=htmlspecialchars($page)?></title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="/favicon.ico">
<link rel="stylesheet" href="/estilo.css">
</head>
<body>
<?php if (is_file(__DIR__ . '/sidebar.php')) require __DIR__ . '/sidebar.php'; ?>
<?= $conteudo ?>
</body>
</html>
