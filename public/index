<?php
declare(strict_types=1);

/**
 * Index do Painel — solução definitiva
 * - Usa suas deps originais
 * - Mantém exigeLogin() e refreshPermissoes()
 * - Rota canônica "dashboard" -> dashboard.php
 * - Output buffer evita "headers already sent"
 */

require_once __DIR__ . '/conexao.php';
require_once __DIR__ . '/config.php';

if (function_exists('exigeLogin')) {
    exigeLogin();
}
if (function_exists('refreshPermissoes')) {
    try { refreshPermissoes($pdo); } catch (Throwable $e) {
        if (getenv('APP_DEBUG') === '1') { error_log('[refreshPermissoes] '.$e->getMessage()); }
    }
}

/** Roteamento */
$page = (string)($_GET['page'] ?? 'dashboard');
$page = preg_replace('/[^a-z0-9_\-]/i', '', $page);

// Mapa base obrigatório (garante dashboard)
$routes_fixed = [
    'dashboard' => __DIR__ . '/dashboard.php',
];

// Se seu config.php definiu $routes, mescla sem sobrescrever o fixed
if (isset($routes) && is_array($routes)) {
    // normaliza caminhos relativos
    $norm = [];
    foreach ($routes as $k => $v) {
        $norm[$k] = str_contains($v, DIRECTORY_SEPARATOR) ? $v : (__DIR__ . '/' . ltrim($v, '/'));
    }
    $routes = array_merge($norm, $routes_fixed);
} else {
    $routes = $routes_fixed;
}

// Resolve alvo
$alvo = $routes[$page] ?? null;

// Fallback suave: page.php e page-2.php (caso ainda existam)
if (!$alvo || !is_file($alvo)) {
    $candidatos = [ __DIR__."/{$page}.php", __DIR__."/{$page}-2.php" ];
    foreach ($candidatos as $c) { if (is_file($c)) { $alvo = $c; break; } }
}

if (!$alvo || !is_file($alvo)) {
    http_response_code(404);
    echo "<!doctype html><meta charset='utf-8'><style>body{font-family:system-ui;background:#0b1a33;color:#fff;padding:40px}</style><h1>404</h1><p>Página não encontrada.</p>";
    exit;
}

// ==== Evita "headers already sent"
ob_start();
require $alvo;
$conteudo = ob_get_clean();

// Se houve redirect, não imprime layout
foreach (headers_list() as $h) { if (stripos($h, 'Location:') === 0) { exit; } }
?>
<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Painel Smile — <?=htmlspecialchars($page)?></title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="/favicon.ico">
<link rel="stylesheet" href="/estilo.css">
</head>
<body>
<?php if (is_file(__DIR__ . '/sidebar.php')) { require __DIR__ . '/sidebar.php'; } ?>
<?= $conteudo ?>
</body>
</html>
